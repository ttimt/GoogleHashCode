<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Chart</title>
        <link rel="stylesheet" href="Chart.css">
        <link rel="stylesheet" href="semantic/semantic.min.css">
        <script type="text/javascript" src="Chart.bundle.min.js"></script>
        <script type="text/javascript" src="jquery-3.4.1.min.js"></script>
        <script type="text/javascript" src="moment.min.js"></script>
        <script type="text/javascript" src="semantic/semantic.min.js"></script>
    </head>
    <body>
        <div style="width: 100%; top: 3%; left: 2%; right: 2%; position: absolute;">
            <div style="float: left; width: 60%; height: 600px"><canvas id="myChart" width="60%" height="100%"></canvas></div>
            <div style="margin-left: 200px; position: relative; text-align: center;">
                <div id="webSocketStatus">Websocket status: <b>Disconnected</b></div><br/>

                <div class="ui animated blue button" tabindex="0" id="runAlgorithmButton" onclick="runAlgorithm()">
                    <div class="visible content">Run algorithm</b></div>
                    <div class="hidden content">
                        <i class="play icon"></i>
                    </div>
                </div>

            </div>
        </div>

        <script>
            var highestDate = moment().set({
				'year': 0,
				'month': 0,
				'date': 0,
				'hour': 0,
				'minute': 0,
				'second': 0,
				'millisecond': 0
			});
            var lowestDate = null;

            var ctx = document.getElementById('myChart').getContext('2d');

            var data = [];

            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    label: ['Red'],
                    datasets: [{
                        label: ["Genetic Algorithm"],
                        data: data,
                        backgroundColor: ['rgba(255, 99, 132, 0.2)'],
                        borderColor: ['rgba(255, 99, 132, 1)'],
                        borderWidth: 2,
                        fill: false,
                        lineTension: 0.5
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0,
                                max: 1800
                            }
                        }],
                        xAxes: [{
                            type: 'time',
                            time: {
                                parser: "HH:mm:ss",
                                unit: 'second',
                            },
                            ticks: {
                                source: 'data',
                                min: '00:00:00',
                                max: '00:00:00',
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 90
                            }
                        }]
                    },
					responsive: true,
					maintainAspectRatio: false
                }
            });

            function updateOption(chart, highestDate, lowestDate) {
                chart.options.scales.xAxes[0].ticks.max = highestDate;
                chart.options.scales.xAxes[0].ticks.min = lowestDate;
            }

            function addData(chart, data) {
                chart.data.datasets[0].data.push(data);

				if(data.x > highestDate)
				{
					highestDate = data.x;
				}
                if(lowestDate == null)
                {
                    lowestDate = data.x;
                }

                updateOption(chart, highestDate, lowestDate);
            }

            function removeData(chart) {
            	while(chart.data.datasets[0].data.length > 0)
				{
					chart.data.datasets[0].data.pop();
				}

                chart.update();
            }

            function DisableButton()
            {
                $('#runAlgorithmButton').addClass("disabled");
            }

            function EnableButton()
            {
                $('#runAlgorithmButton').removeClass("disabled");
            }
        </script>
		<script>
			var socketStatusElement = document.getElementById("webSocketStatus");
			var socket = new WebSocket("ws://" + window.location.host + "/ws");

			socket.onopen = function () {
				socketStatusElement.innerHTML = "Websocket status: <b>Connected</b>";
			}

			// On receive message
			socket.onmessage = function (e) {
				data = JSON.parse(e.data);
				data = [data]

                // Check the data if algorithm ends = true, enable button again
                if(data[0].action == "end" && data[0].data)
                {
                    EnableButton();
                    return;
                }

                console.log(data[0])

				data.forEach( d => {
				    d.data.x = moment(d.data.x, "HH:mm:ss");

					addData(myChart, d.data);
				});

				myChart.update();
			}

            socket.onerror = function () {
				socketStatusElement.innerHTML = "Websocket status: <b>Error</b>";
            }

            socket.onclose = function () {
				socketStatusElement.innerHTML = "Websocket status: <b>Disconnected</b>";
            }

			// Send data
			function send(dataToSend) {
                socket.send(JSON.stringify(dataToSend))
			}

            function runAlgorithm() {
                DisableButton();

                var dataToSend = {"action": "send", "data": true};
                send(dataToSend);
            }

			window.onbeforeunload = function () {
				socketStatusElement.innerHTML = "Websocket status: <b>Disconnected</b>";
				socket.close();
			}
		</script>
    </body>
</html>