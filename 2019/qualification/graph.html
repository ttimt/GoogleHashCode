<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Chart</title>
        <link rel="stylesheet" href="Chart.css">
        <script type="text/javascript" src="Chart.bundle.min.js"></script>
        <script type="text/javascript" src="moment.min.js"></script>
    </head>
    <body>
        <canvas id="myChart" width="300" height="200"></canvas>
		<p id="webSocketStatus" style="text-align: center">Status: <b>Disconnected</b></p>

        <script>
            var highestDate = moment().set({
				'year': 0,
				'month': 0,
				'date': 0,
				'hour': 0,
				'minute': 0,
				'second': 0,
				'millisecond': 0
			});

            var ctx = document.getElementById('myChart').getContext('2d');

            var data = [];

            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    label: ['Red'],
                    datasets: [{
                        label: ["Genetic Algorithm"],
                        data: data,
                        backgroundColor: ['rgba(255, 99, 132, 0.2)'],
                        borderColor: ['rgba(255, 99, 132, 1)'],
                        borderWidth: 2,
                        fill: false,
                        lineTension: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0,
                                max: 1800
                            }
                        }],
                        xAxes: [{
                            type: 'time',
                            time: {
                                parser: "HH:mm:ss",
                                unit: 'second',
                            },
                            ticks: {
                                source: 'data',
                                min: '00:00:00',
                                max: '12:00:00'
                            }
                        }]
                    },
					responsive: true,
					maintainAspectRatio: true
                }
            });

            function updateOption(chart, highestDate) {
                chart.options.scales.xAxes[0].ticks.max = highestDate;
            }

            function addData(chart, data) {
                chart.data.datasets[0].data.push(data);

				if(data.x > highestDate)
				{
					highestDate = data.x;
				}

                updateOption(chart, highestDate);
            }

            function removeData(chart) {
            	while(chart.data.datasets[0].data.length > 0)
				{
					chart.data.datasets[0].data.pop();
				}

                chart.update();
            }
        </script>
		<script>
			var socketStatusElement = document.getElementById("webSocketStatus");
			var socket = new WebSocket("ws://" + window.location.host + "/ws");
            // removeData(myChart);

			socket.onopen = function () {
				socketStatusElement.innerHTML = "Status: <b>Connected</b>";
			}

			// On receive message
			socket.onmessage = function (e) {

				data = JSON.parse(e.data);
				data = [data]

				data[0].forEach( d => {
				    d.x = moment(d.x, "HH:mm:ss");

					addData(myChart, d);
				})

				myChart.update();
			}

			// Send data
			function send() {

			}

			window.onbeforeunload = function () {
				socket.close();
			}
		</script>
    </body>
</html>